<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 NTRIP Test Runner</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-pass { background: #d4edda; border-color: #c3e6cb; }
        .test-fail { background: #f8d7da; border-color: #f5c6cb; }
        .test-pending { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #006da3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; font-family: monospace; }
        .log { background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; max-height: 200px; overflow-y: auto; }
        .controls { text-align: center; margin: 20px 0; }
        .status { font-weight: bold; font-size: 18px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ ESP32 NTRIP Test Runner</h1>
        <p>Interactive test suite for validating "L∆∞u c·∫•u h√¨nh" functionality</p>
        
        <div class="controls">
            <button onclick="runAllTests()">üöÄ Run All Tests</button>
            <button onclick="openMainPage()">üåê Open Main Page</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
        
        <div class="status" id="overall-status">Status: Ready to test</div>
        
        <div class="test-section test-pending" id="test-1">
            <h3>Test 1: Page Load & Element Detection</h3>
            <button onclick="runTest1()">Run Test</button>
            <div class="result" id="result-1">Not run yet</div>
        </div>
        
        <div class="test-section test-pending" id="test-2">
            <h3>Test 2: Form Submission Flow</h3>
            <button onclick="runTest2()">Run Test</button>
            <div class="result" id="result-2">Not run yet</div>
        </div>
        
        <div class="test-section test-pending" id="test-3">
            <h3>Test 3: Modal Display</h3>
            <button onclick="runTest3()">Run Test</button>
            <div class="result" id="result-3">Not run yet</div>
        </div>
        
        <div class="test-section test-pending" id="test-4">
            <h3>Test 4: UART Toggle</h3>
            <button onclick="runTest4()">Run Test</button>
            <div class="result" id="result-4">Not run yet</div>
        </div>
        
        <div class="test-section test-pending" id="test-5">
            <h3>Test 5: Debug Tools</h3>
            <button onclick="runTest5()">Run Test</button>
            <div class="result" id="result-5">Not run yet</div>
        </div>
        
        <div class="log" id="console-log">Console output will appear here...</div>
    </div>

    <script>
        let testResults = { passed: 0, failed: 0, total: 5 };
        let mainWindow = null;
        
        function log(message) {
            const logElement = document.getElementById('console-log');
            logElement.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function setTestResult(testNum, passed, message) {
            const testElement = document.getElementById(`test-${testNum}`);
            const resultElement = document.getElementById(`result-${testNum}`);
            
            testElement.className = `test-section ${passed ? 'test-pass' : 'test-fail'}`;
            resultElement.textContent = message;
            
            if (passed) {
                testResults.passed++;
                log(`‚úÖ Test ${testNum}: PASS - ${message}`);
            } else {
                testResults.failed++;
                log(`‚ùå Test ${testNum}: FAIL - ${message}`);
            }
            
            updateOverallStatus();
        }
        
        function updateOverallStatus() {
            const completed = testResults.passed + testResults.failed;
            const statusElement = document.getElementById('overall-status');
            
            if (completed === 0) {
                statusElement.textContent = 'Status: Ready to test';
                statusElement.style.color = '#333';
            } else if (completed < testResults.total) {
                statusElement.textContent = `Status: Running tests... (${completed}/${testResults.total})`;
                statusElement.style.color = '#007cba';
            } else {
                const rate = (testResults.passed / testResults.total * 100).toFixed(1);
                if (testResults.failed === 0) {
                    statusElement.textContent = `Status: ALL TESTS PASSED! üéâ (${rate}%)`;
                    statusElement.style.color = '#28a745';
                } else {
                    statusElement.textContent = `Status: ${testResults.failed} tests failed (${rate}% pass rate)`;
                    statusElement.style.color = '#dc3545';
                }
            }
        }
        
        function openMainPage() {
            if (mainWindow && !mainWindow.closed) {
                mainWindow.focus();
            } else {
                mainWindow = window.open('index.html', 'mainPage', 'width=1200,height=800');
                log('Main page opened in new window');
            }
        }
        
        function runTest1() {
            log('Running Test 1: Page Load & Element Detection');
            
            if (!mainWindow || mainWindow.closed) {
                setTestResult(1, false, 'Main page not opened. Click "Open Main Page" first.');
                return;
            }
            
            try {
                const mainDoc = mainWindow.document;
                const form = mainDoc.getElementById('config-form');
                const submitButton = mainDoc.querySelector('button[type="submit"]');
                const uartToggle = mainDoc.querySelector('#uart-toggle');
                
                const checks = [
                    { name: 'Form found', result: !!form },
                    { name: 'Submit button found', result: !!submitButton },
                    { name: 'Submit in form', result: form && submitButton ? form.contains(submitButton) : false },
                    { name: 'UART toggle found', result: !!uartToggle }
                ];
                
                const allPassed = checks.every(check => check.result);
                const details = checks.map(c => `${c.name}: ${c.result ? '‚úÖ' : '‚ùå'}`).join(', ');
                
                setTestResult(1, allPassed, details);
            } catch (error) {
                setTestResult(1, false, `Error: ${error.message}`);
            }
        }
        
        function runTest2() {
            log('Running Test 2: Form Submission Flow');
            
            if (!mainWindow || mainWindow.closed) {
                setTestResult(2, false, 'Main page not opened. Click "Open Main Page" first.');
                return;
            }
            
            try {
                const mainDoc = mainWindow.document;
                const form = mainDoc.getElementById('config-form');
                const submitButton = mainDoc.querySelector('button[type="submit"]');
                
                if (!form || !submitButton) {
                    setTestResult(2, false, 'Form or submit button not found');
                    return;
                }
                
                // Monitor console for logs
                let eventFired = false;
                const originalLog = mainWindow.console.log;
                mainWindow.console.log = function(...args) {
                    originalLog.apply(this, args);
                    const message = args.join(' ');
                    if (message.includes('Form submit event triggered')) {
                        eventFired = true;
                    }
                };
                
                // Trigger submit
                submitButton.click();
                
                setTimeout(() => {
                    mainWindow.console.log = originalLog;
                    setTestResult(2, eventFired, eventFired ? 'Form submit event detected' : 'No form submit event detected');
                }, 1000);
                
            } catch (error) {
                setTestResult(2, false, `Error: ${error.message}`);
            }
        }
        
        function runTest3() {
            log('Running Test 3: Modal Display');
            
            if (!mainWindow || mainWindow.closed) {
                setTestResult(3, false, 'Main page not opened. Click "Open Main Page" first.');
                return;
            }
            
            try {
                const mainDoc = mainWindow.document;
                const modal = mainDoc.getElementById('restarting-modal');
                
                if (!modal) {
                    setTestResult(3, false, 'Restarting modal not found');
                    return;
                }
                
                // Test modal show/hide
                const wasHidden = modal.classList.contains('hidden');
                modal.classList.remove('hidden');
                const isShowing = !modal.classList.contains('hidden');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                    const isHiddenAgain = modal.classList.contains('hidden');
                    
                    const passed = wasHidden && isShowing && isHiddenAgain;
                    setTestResult(3, passed, passed ? 'Modal show/hide works correctly' : 'Modal show/hide failed');
                }, 1000);
                
            } catch (error) {
                setTestResult(3, false, `Error: ${error.message}`);
            }
        }
        
        function runTest4() {
            log('Running Test 4: UART Toggle');
            
            if (!mainWindow || mainWindow.closed) {
                setTestResult(4, false, 'Main page not opened. Click "Open Main Page" first.');
                return;
            }
            
            try {
                const mainDoc = mainWindow.document;
                const uartToggle = mainDoc.querySelector('#uart-toggle');
                const uartConfig = mainDoc.querySelector('#uart-config');
                
                if (!uartToggle || !uartConfig) {
                    setTestResult(4, false, 'UART elements not found');
                    return;
                }
                
                const initialState = uartConfig.classList.contains('show');
                uartToggle.click();
                
                setTimeout(() => {
                    const newState = uartConfig.classList.contains('show');
                    const toggled = initialState !== newState;
                    setTestResult(4, toggled, toggled ? 'UART toggle works correctly' : 'UART toggle failed');
                }, 500);
                
            } catch (error) {
                setTestResult(4, false, `Error: ${error.message}`);
            }
        }
        
        function runTest5() {
            log('Running Test 5: Debug Tools');
            
            if (!mainWindow || mainWindow.closed) {
                setTestResult(5, false, 'Main page not opened. Click "Open Main Page" first.');
                return;
            }
            
            try {
                const checks = [
                    { name: 'testFormSubmit function', result: typeof mainWindow.testFormSubmit === 'function' },
                    { name: 'runFormTest function', result: typeof mainWindow.runFormTest === 'function' },
                    { name: 'runModalTest function', result: typeof mainWindow.runModalTest === 'function' }
                ];
                
                const allPassed = checks.every(check => check.result);
                const details = checks.map(c => `${c.name}: ${c.result ? '‚úÖ' : '‚ùå'}`).join(', ');
                
                setTestResult(5, allPassed, details);
                
            } catch (error) {
                setTestResult(5, false, `Error: ${error.message}`);
            }
        }
        
        function runAllTests() {
            log('üöÄ Starting comprehensive test suite...');
            clearResults();
            
            if (!mainWindow || mainWindow.closed) {
                openMainPage();
                setTimeout(() => {
                    runTest1();
                    setTimeout(() => runTest2(), 1000);
                    setTimeout(() => runTest3(), 2000);
                    setTimeout(() => runTest4(), 3000);
                    setTimeout(() => runTest5(), 4000);
                }, 2000);
            } else {
                runTest1();
                setTimeout(() => runTest2(), 1000);
                setTimeout(() => runTest3(), 2000);
                setTimeout(() => runTest4(), 3000);
                setTimeout(() => runTest5(), 4000);
            }
        }
        
        function clearResults() {
            testResults = { passed: 0, failed: 0, total: 5 };
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`test-${i}`).className = 'test-section test-pending';
                document.getElementById(`result-${i}`).textContent = 'Not run yet';
            }
            document.getElementById('console-log').textContent = 'Console cleared...\n';
            updateOverallStatus();
            log('Test results cleared');
        }
        
        log('üß™ Test Runner initialized. Click "Run All Tests" to start.');
    </script>
</body>
</html>
