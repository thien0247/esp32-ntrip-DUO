<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 NTRIP Duo Configuration</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <style>
        /* UART Toggle Fix */
        .section.advanced .section-content {
            display: none !important;
        }
        .section.advanced .section-content.show {
            display: block !important;
        }
        
        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #007cba;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .modal-buttons {
            margin-top: 20px;
            text-align: center;
        }
        
        #check-status {
            text-align: center;
            font-weight: bold;
            color: #007cba;
        }
        
        /* Submit Section */
        .submit-section {
            margin: 20px 0;
            text-align: center;
            padding: 20px;
            border-top: 1px solid #ddd;
        }
        
        .submit-section button {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ESP32 NTRIP Duo Configuration - ntrip.io.vn</h1>
            <p class="version">Version <span id="project-version">loading...</span></p>
            <p class="description">Điều chỉnh cài đặt bên dưới và nhấn "Lưu cấu hình". Thiết bị sẽ khởi động lại với cài đặt mới.</p>
        </header>

        <main class="main">
            <form id="config-form" class="config-form" method="post" action="" novalidate>
                
                <!-- WiFi Station Section -->
                <section class="section">
                    <div class="section-header">
                        <h2>WiFi Station Mode</h2>
                        <div class="controls">
                            <div class="switch">
                                <input type="checkbox" id="wifi-sta-enable" name="w_sta_active" value="1">
                                <label for="wifi-sta-enable"></label>
                            </div>
                            <input type="color" name="w_sta_color" value="#ffffff" class="color-picker">
                        </div>
                        <div class="status" id="wifi-sta-status">Không hoạt động</div>
                    </div>
                    
                    <div class="section-content">
                        <div class="form-group">
                            <label for="wifi-ssid">SSID</label>
                            <div class="input-group">
                                <input type="text" id="wifi-ssid" name="w_sta_ssid" maxlength="32" required>
                                <button type="button" class="btn-secondary" id="wifi-scan">Quét</button>
                            </div>
                            <select id="wifi-networks" class="hidden">
                                <option value="">Chọn mạng...</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="wifi-password">Mật khẩu</label>
                            <input type="password" id="wifi-password" name="w_sta_pass">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Chế độ quét</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="w_sta_scan_mode" value="0" checked> Nhanh</label>
                                    <label><input type="radio" name="w_sta_scan_mode" value="1"> Tất cả kênh</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Cấu hình IP</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="w_sta_static" value="0" checked> DHCP</label>
                                    <label><input type="radio" name="w_sta_static" value="1"> Static</label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="static-ip-config" class="hidden">
                            <div class="form-group">
                                <label>Địa chỉ IP</label>
                                <div class="ip-input">
                                    <input type="number" name="w_sta_ip" value="192" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_ip" value="168" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_ip" value="1" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_ip" value="100" min="0" max="255">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Gateway</label>
                                <div class="ip-input">
                                    <input type="number" name="w_sta_gw" value="192" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_gw" value="168" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_gw" value="1" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_gw" value="1" min="0" max="255">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>DNS</label>
                                <div class="ip-input">
                                    <input type="number" name="w_sta_dns_a" value="8" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_dns_a" value="8" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_dns_a" value="8" min="0" max="255">
                                    <span>.</span>
                                    <input type="number" name="w_sta_dns_a" value="8" min="0" max="255">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- WiFi Access Point Section -->
                <section class="section">
                    <div class="section-header">
                        <h2>WiFi Access Point / Hotspot</h2>
                        <div class="controls">
                            <div class="switch">
                                <input type="checkbox" id="wifi-ap-enable" name="w_ap_active" value="1" checked>
                                <label for="wifi-ap-enable"></label>
                            </div>
                            <input type="color" name="w_ap_color" value="#ffffff" class="color-picker">
                        </div>
                        <div class="status" id="wifi-ap-status">Hoạt động</div>
                    </div>
                    
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="ap-ssid">SSID</label>
                                <div class="input-group">
                                    <input type="text" id="ap-ssid" name="w_ap_ssid" value="ESP32-NTRIP-Hotspot" maxlength="32">
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="w_ap_ssid_hid" value="1"> Ẩn SSID
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="ap-password">Mật khẩu</label>
                                <input type="password" id="ap-password" name="w_ap_pass">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Bảo mật</label>
                                <select name="w_ap_auth_mode">
                                    <option value="0">Mở (Open)</option>
                                    <option value="1">WEP</option>
                                    <option value="2">WPA-PSK</option>
                                    <option value="3">WPA2-PSK</option>
                                    <option value="4" selected>WPA/2-PSK (Khuyến nghị)</option>
                                    <option value="5">WPA2 Enterprise</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Gateway và subnet</label>
                                <div class="ip-gateway-group">
                                    <div class="ip-input-detailed">
                                        <span class="ip-prefix">192.168.</span>
                                        <input type="hidden" name="w_ap_gw" value="192">
                                        <input type="hidden" name="w_ap_gw" value="168">
                                        <input type="number" name="w_ap_gw" value="4" maxlength="3" min="0" max="255" required class="ip-octet">
                                        <span class="ip-separator">.</span>
                                        <input type="number" name="w_ap_gw" value="1" maxlength="3" min="1" max="254" required class="ip-octet">
                                        <span class="ip-separator">/</span>
                                        <select name="w_ap_subnet" class="subnet-select" required>
                                            <option value="24" selected>24</option>
                                            <option value="25">25</option>
                                            <option value="26">26</option>
                                            <option value="27">27</option>
                                            <option value="28">28</option>
                                            <option value="29">29</option>
                                            <option value="30">30</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Phạm vi IP</label>
                                <div class="ip-range-group">
                                    <span class="ip-prefix">192.168.4.</span>
                                    <input type="number" name="w_ap_ip_min" value="1" min="1" max="254" class="ip-octet">
                                    <span class="ip-separator">-</span>
                                    <input type="number" name="w_ap_ip_max" value="254" min="1" max="254" class="ip-octet">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Admin Security Section -->
                <section class="section">
                    <div class="section-header">
                        <h2>Bảo mật Admin</h2>
                    </div>
                    
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phương thức xác thực</label>
                                <select name="adm_auth">
                                    <option value="0">Mở (Open)</option>
                                    <option value="1">Chỉ thiết bị hotspot</option>
                                    <option value="2" selected>Username/Password</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="admin-user">Username</label>
                                <input type="text" id="admin-user" name="adm_user" value="admin" maxlength="32">
                            </div>
                            
                            <div class="form-group">
                                <label for="admin-pass">Password</label>
                                <input type="password" id="admin-pass" name="adm_pass" maxlength="64">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- NTRIP Server A Section -->
                <section class="section">
                    <div class="section-header">
                        <h2>NTRIP Server A</h2>
                        <div class="controls">
                            <div class="switch">
                                <input type="checkbox" id="ntrip-srv-enable" name="ntr_srv_active" value="1">
                                <label for="ntrip-srv-enable"></label>
                            </div>
                            <input type="color" name="ntr_srv_color" value="#ffffff" class="color-picker">
                        </div>
                        <div class="status" id="ntrip-srv-status">Không hoạt động</div>
                    </div>
                    
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="srv-host">Server Host</label>
                                <input type="text" id="srv-host" name="ntr_srv_host" placeholder="ntrip.example.com" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="srv-port">Port</label>
                                <input type="number" id="srv-port" name="ntr_srv_port" value="2101" min="1" max="65535" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="srv-mountpoint">Mountpoint</label>
                                <input type="text" id="srv-mountpoint" name="ntr_srv_mp" placeholder="MOUNT1" maxlength="32" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="srv-user">Username</label>
                                <input type="text" id="srv-user" name="ntr_srv_user">
                            </div>
                            
                            <div class="form-group">
                                <label for="srv-pass">Password</label>
                                <input type="password" id="srv-pass" name="ntr_srv_pass">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- NTRIP Server B Section -->
                <section class="section">
                    <div class="section-header">
                        <h2>NTRIP Server B</h2>
                        <div class="controls">
                            <div class="switch">
                                <input type="checkbox" id="ntrip-srv2-enable" name="ntr_srv2_active" value="1">
                                <label for="ntrip-srv2-enable"></label>
                            </div>
                            <input type="color" name="ntr_srv2_color" value="#ffffff" class="color-picker">
                        </div>
                        <div class="status" id="ntrip-srv2-status">Không hoạt động</div>
                    </div>
                    
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="srv2-host">Server Host</label>
                                <input type="text" id="srv2-host" name="ntr_srv2_host" placeholder="ntrip2.example.com" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="srv2-port">Port</label>
                                <input type="number" id="srv2-port" name="ntr_srv2_port" value="2101" min="1" max="65535" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="srv2-mountpoint">Mountpoint</label>
                                <input type="text" id="srv2-mountpoint" name="ntr_srv2_mp" placeholder="MOUNT2" maxlength="32" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="srv2-user">Username</label>
                                <input type="text" id="srv2-user" name="ntr_srv2_user">
                            </div>
                            
                            <div class="form-group">
                                <label for="srv2-pass">Password</label>
                                <input type="password" id="srv2-pass" name="ntr_srv2_pass">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- NTRIP Client Section -->
                <section class="section">
                    <div class="section-header">
                        <h2>NTRIP Client</h2>
                        <div class="controls">
                            <div class="switch">
                                <input type="checkbox" id="ntrip-cli-enable" name="ntr_cli_active" value="1">
                                <label for="ntrip-cli-enable"></label>
                            </div>
                            <input type="color" name="ntr_cli_color" value="#ffffff" class="color-picker">
                        </div>
                        <div class="status" id="ntrip-cli-status">Không hoạt động</div>
                    </div>
                    
                    <div class="section-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cli-host">Server Host</label>
                                <input type="text" id="cli-host" name="ntr_cli_host" placeholder="ntrip-client.com" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="cli-port">Port</label>
                                <input type="number" id="cli-port" name="ntr_cli_port" value="2101" min="1" max="65535" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="cli-mountpoint">Mountpoint</label>
                                <input type="text" id="cli-mountpoint" name="ntr_cli_mp" placeholder="MOUNT_CLIENT" maxlength="32" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cli-user">Username</label>
                                <input type="text" id="cli-user" name="ntr_cli_user">
                            </div>
                            
                            <div class="form-group">
                                <label for="cli-pass">Password</label>
                                <input type="password" id="cli-pass" name="ntr_cli_pass">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- UART Communication Section -->
                <section class="section advanced">
                    <div class="section-header">
                        <h2>UART Communication</h2>
                        <button type="button" class="btn-link" id="uart-toggle">Cấu hình nâng cao</button>
                        <div class="status" id="uart-status">UART0 - 115200 baud</div>
                    </div>
                    
                    <div class="section-content" id="uart-config">
                        <div class="form-row">
                            <div class="form-group">
                                <label>UART Controller</label>
                                <div class="radio-group">
                                    <label><input type="radio" name="uart_num" value="0" checked> UART 0</label>
                                    <label><input type="radio" name="uart_num" value="1"> UART 1</label>
                                    <label><input type="radio" name="uart_num" value="2"> UART 2</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="uart-baud">Baud Rate</label>
                                <select id="uart-baud" name="uart_baud_rate">
                                    <option value="9600">9600</option>
                                    <option value="19200">19200</option>
                                    <option value="38400">38400</option>
                                    <option value="57600">57600</option>
                                    <option value="115200" selected>115200</option>
                                    <option value="230400">230400</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="uart-tx">TX Pin</label>
                                <input type="number" id="uart-tx" name="uart_tx_pin" value="1" min="0" max="39">
                            </div>
                            
                            <div class="form-group">
                                <label for="uart-rx">RX Pin</label>
                                <input type="number" id="uart-rx" name="uart_rx_pin" value="3" min="0" max="39">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="uart-data-bits">Data Bits</label>
                                <select id="uart-data-bits" name="uart_data_bits">
                                    <option value="0">5</option>
                                    <option value="1">6</option>
                                    <option value="2">7</option>
                                    <option value="3" selected>8</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="uart-stop-bits">Stop Bits</label>
                                <select id="uart-stop-bits" name="uart_stop_bits">
                                    <option value="1" selected>1</option>
                                    <option value="2">1.5</option>
                                    <option value="3">2</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="uart-parity">Parity</label>
                                <select id="uart-parity" name="uart_parity">
                                    <option value="0" selected>Disabled</option>
                                    <option value="2">Even</option>
                                    <option value="3">Odd</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Flow Control</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="uart_fc_rts" value="1"> RTS
                                    </label>
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="uart_fc_cts" value="1"> CTS
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="uart-rts-pin">RTS Pin</label>
                                <input type="number" id="uart-rts-pin" name="uart_rts_pin" value="22" min="0" max="39">
                            </div>
                            
                            <div class="form-group">
                                <label for="uart-cts-pin">CTS Pin</label>
                                <input type="number" id="uart-cts-pin" name="uart_cts_pin" value="19" min="0" max="39">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="checkbox-inline">
                                    <input type="checkbox" name="uart_log_fwd" value="1"> Log Forward (Print)
                                </label>
                                <small class="help-text">Chuyển tiếp log messages đến UART chính cho debug</small>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Submit Section -->
                <!-- Bluetooth Section -->
                <section class="section">
                    <div class="section-header">
                        <h2>Bluetooth</h2>
                        <div class="controls">
                            <label class="toggle">
                                <input type="checkbox" name="bt_active" value="1" id="bluetooth-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="section-content" id="bluetooth-config">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="bt-device-name">Tên thiết bị</label>
                                <div class="input-group">
                                    <input type="text" id="bt-device-name" name="bt_dev_name" maxlength="32" required>
                                    <label class="checkbox-inline">
                                        <input type="checkbox" name="bt_dev_vis" value="1" checked> Có thể khám phá
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="bt-pin">Mã PIN (4 chữ số)</label>
                                <div class="pin-input">
                                    <input type="number" name="bt_pin_code" class="pin-digit" maxlength="1" min="0" max="9" pattern="[0-9]" oninput="autoTab(this)" required>
                                    <input type="number" name="bt_pin_code" class="pin-digit" maxlength="1" min="0" max="9" pattern="[0-9]" oninput="autoTab(this)" required>
                                    <input type="number" name="bt_pin_code" class="pin-digit" maxlength="1" min="0" max="9" pattern="[0-9]" oninput="autoTab(this)" required>
                                    <input type="number" name="bt_pin_code" class="pin-digit" maxlength="1" min="0" max="9" pattern="[0-9]" oninput="autoTab(this)" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <div class="submit-section">
                    <button type="submit" class="btn-primary">Lưu cấu hình</button>
                    <button type="button" class="btn-secondary" id="reset-config">Khôi phục mặc định</button>
                </div>

            </form>
        </main>

        <footer class="footer">
            <div class="actions">
                <!-- Buttons moved inside form -->
            </div>
            
            <div class="info">
                <span>Uptime: <span id="uptime">loading...</span></span>
                <span>Memory: <span id="memory">loading...</span></span>
                <span>&copy; 2024 ntrip.io.vn</span>
            </div>
        </footer>
    </div>

    <!-- Restarting Modal (compatible with original) -->
    <div id="restarting-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Đang khởi động lại...</h3>
            <p>ESP32 đã được khởi động lại để áp dụng cấu hình mới.</p>
            <p>Vui lòng đợi một vài giây, trang sẽ tự động tải lại.</p>
            <p>Nếu bạn đã thay đổi cài đặt WiFi, có thể cần kiểm tra kết nối WiFi hoặc đọc địa chỉ IP mới từ serial terminal.</p>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Device Check Modal -->
    <div id="device-check-modal" class="modal hidden">
        <div class="modal-content">
            <h3>Kiểm tra thiết bị</h3>
            <p>Đang kiểm tra xem thiết bị đã khởi động lại chưa...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="check-progress"></div>
            </div>
            <p id="check-status">Thời gian còn lại: <span id="countdown">10</span>s</p>
            <div class="modal-buttons">
                <button id="manual-reload" class="btn-primary">Tải lại trang ngay</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="uart-fix.js"></script>
    <script src="form-fix.js"></script>
    <script>if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js')}</script>
</body>
</html>
